<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script
      src="https://code.jquery.com/jquery-3.5.1.min.js"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"
    ></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.0.0/p5.min.js'></script>
    <script src='https://cdn.webrtc-experiment.com/MediaStreamRecorder.js'></script>
    <title>Index</title>
  </head>
  <body>
    <button onclick="startRec()" id="mic">Get Voice!</button><button onclick='stopRec()'>Stop</button>
  </body>
  <script>
      function captureUserMedia(mediaConstraints, successCallback, errorCallback) {
    navigator.mediaDevices.getUserMedia(mediaConstraints).then(successCallback).catch(errorCallback);
  }
  var mediaConstraints = {
    audio: true
  };
  function startRec()
  {
    captureUserMedia(mediaConstraints, onMediaSuccess, onMediaError);
  }
 
  function saveRecording() {
      mediaRecorder.save();
  };

  var mediaRecorder;
  const chunks = [];
  blob = new Blob(chunks, {'type': 'audio/wav;'});
  function onMediaSuccess(stream) {
    mediaRecorder = new MediaStreamRecorder(stream);
    mediaRecorder.stream = stream;
    mediaRecorder.mimeType = 'audio/wav';    
    mediaRecorder.audioChannels = 1;
    mediaRecorder.ondataavailable = e => {
    chunks.push(e.data);
}
  }
  function onMediaError(e) {
    console.error('media error', e);
  }
  function stopRec() {

    mediaRecorder.stop();
    mediaRecorder.stream.stop();
    mediaRecorder.save();
    fetch('/', {
  method: "post",
  body: blob
});
  };

  </script>
</html>
